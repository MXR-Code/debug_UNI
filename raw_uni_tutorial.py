Nature
Medicineå¤ç°ï½œç—…ç†AIé¢†åŸŸçš„åŸºç¡€æ¨¡å‹ä¸ä¼šç”¨ï¼Ÿè¿™ç¯‡ä¿å§†çº§æ•™ç¨‹å¸¦ä½ æŒæ¡æ•°æ®å¤„ç†å…¨æµç¨‹ï¼ å·²ä»˜è´¹
å°ç½—ç¢ç¢å¿µ
åœ¨åŒ»å­¦AIé¢†åŸŸï¼Œè®¡ç®—ç—…ç†å­¦å¯¹äºç–¾ç—…è¯Šæ–­æ„ä¹‰é‡å¤§ï¼Œè€ŒUNIæ¨¡å‹çš„å‡ºç°ä¸ºè¯¥é¢†åŸŸå¸¦æ¥äº†æ–°çªç ´ã€‚

ä»Šå¤©è¿™æœŸå¸¦é¢†å¤§å®¶å¤ç°ä¸€ç¯‡å‘è¡¨äºNature
Medicineçš„æ–‡ç« ï¼Œä»‹ç»çš„æ˜¯ç”¨äºè®¡ç®—ç—…ç†å­¦çš„é€šç”¨è‡ªç›‘ç£æ¨¡å‹UNIâ€”â€”é€šè¿‡åœ¨å¤§è§„æ¨¡ç»„ç»‡å›¾åƒæ•°æ®é›†ä¸Šçš„é¢„è®­ç»ƒï¼ŒUNIåœ¨å¤šç§è®¡ç®—ç—…ç†å­¦ä»»åŠ¡ä¸­å±•ç°å‡ºä¼˜å¼‚æ€§èƒ½ï¼Œä¸ºè¯¥é¢†åŸŸçš„äººå·¥æ™ºèƒ½æ¨¡å‹å‘å±•æä¾›äº†é‡è¦åŸºç¡€ã€‚

https: // doi.org / 10.1038 / s41591 - 024 - 02
857 - 3
https: // doi.org / 10.1038 / s41591 - 024 - 02
857 - 3
éšç€æ•°æ®é‡å¢åŠ ï¼ŒUNIæ€§èƒ½æå‡æ˜¾è‘—ï¼Œåœ¨å¤æ‚ç™Œç—‡åˆ†ç±»ä»»åŠ¡ä¸Šè¶…è¶Šå…¶ä»–æ¨¡å‹ã€‚åœ¨å¼±ç›‘ç£åˆ‡ç‰‡åˆ†ç±»ã€ROIåˆ†ç±»ã€æ£€ç´¢å’Œç»†èƒç±»å‹åˆ†å‰²ç­‰å¤šç§ä¸´åºŠä»»åŠ¡è¯„ä¼°ä¸­ï¼ŒUNIä¹Ÿå±•ç°å‡ºä¼˜åŠ¿ï¼Œå°¤å…¶åœ¨ç½•è§ç—…åˆ†ç±»æ–¹é¢æ•ˆæœçªå‡ºï¼Œå…¶å°‘æ ·æœ¬å­¦ä¹ èƒ½åŠ›èƒ½ä»¥å°‘é‡æ ·æœ¬å®ç°é«˜æ•ˆåˆ†ç±»ã€‚

UNIæ˜¯å»å¹´å‘è¡¨çš„ï¼Œç»è¿‡ä¸€å¹´çš„æ—¶é—´æ£€éªŒï¼Œç°åœ¨å·²ç»æˆä¸ºäº†ç—…ç†AIé¢†åŸŸå®¶å–»æˆ·æ™“çš„æ¨¡å‹ã€‚æˆ‘å·²ç»åœ¨ä¹‹å‰çš„æ¨é€ä¸­è¯¦ç»†è§£è¯»è¿‡UNIè¿™ç¯‡æ–‡çŒ®ï¼Œè¿™æœŸæ¨é€ä¾§é‡äºå¦‚ä½•å¤ç°é¡¹ç›®ï¼Œæ‰€ä»¥ä¸å†è§£è¯»æ–‡çŒ®ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è·³è½¬é“¾æ¥é˜…è¯»ã€‚

Nature
Medicineç—…ç†AIæ±‡æ€»ï½œUNIï¼šä¸€ç§ç”¨äºè®¡ç®—ç—…ç†å­¦çš„é€šç”¨è‡ªç›‘ç£åŸºç¡€æ¨¡å‹Â·é¡¶åˆŠç²¾æÂ·24 - 10 - 31

æ–‡çŒ®ä¸­æåˆ°ï¼ŒUNIçš„å°æ ·æœ¬å­¦ä¹ èƒ½åŠ›å¾ˆå‡ºè‰²ï¼Œé‚£ä¹ˆæˆ‘ä¹Ÿåšäº†ä¸€ä¸ªå°å°çš„æµ‹è¯•â€”â€”ç”¨ä¸€ä¸ªç»“ç›´è‚ ç™Œ10Kå’Œ100Kçš„æ•°æ®é›†åšäº†ä¸€ä¸ªå¯¹æ¯”ï¼Œæµ‹è¯•é›†å¤§å°ä¿æŒä¸å˜ï¼Œç»“æœå‘ç°10Kæ•°æ®é›†çš„æŸäº›å‚æ•°æ›´å¥½ï¼

è¿™é‡Œåªå±•ç¤ºä¸€ä¸ªæµ‹è¯•ç»“æœï¼Œæ¨æ–‡ä¸­è¿˜æœ‰å¾ˆå¤šå…¶ä»–å®éªŒç»“æœ
è¿™é‡Œåªå±•ç¤ºä¸€ä¸ªæµ‹è¯•ç»“æœï¼Œæ¨æ–‡ä¸­è¿˜æœ‰å¾ˆå¤šå…¶ä»–å®éªŒç»“æœ
è¿™å¼ å›¾ä¹Ÿå‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªç»“è®ºï¼Œè™½ç„¶ç†è®ºä¸Šæ•°æ®é‡è¶Šå¤§ï¼Œæ¨¡å‹çš„æ€§èƒ½ä¼šè¶Šå¥½ï¼Œä½†æ˜¯ä¹Ÿä¸ä¸€å®šè¦ä¸€å‘³çš„è¿½æ±‚æ•°æ®é‡ï¼Œè´¨é‡æ¯”æ•°é‡æ›´é‡è¦ï¼é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šè‡ªå·±çš„æ•°æ®é›†è´¨é‡æ˜¯å¦è¾¾æ ‡å‘¢ï¼Ÿ

è§£å†³ä¸Šè¿°é—®é¢˜çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è¦å­¦ä¼šåˆ†æä½ æ‹¥æœ‰çš„æ•°æ®é›†ï¼Œæ‰€ä»¥è¿™æœŸæ¨é€æˆ‘ä¹Ÿä¼šæ‰‹æŠŠæ‰‹å¸¦å¤§å®¶åˆ†æä¸€ä¸ªæ•°æ®é›†ï¼Œçœ‹çœ‹æ•°æ®é›†çš„ç»„æˆæƒ…å†µã€‚

ä¾‹å¦‚è¿™æ˜¯ä¸€ä¸ª9åˆ†ç±»æ•°æ®é›†ï¼Œæˆ‘ä»¬ç°åœ¨æŸ¥çœ‹è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„æ•°æ®ç»“æ„
ä¾‹å¦‚è¿™æ˜¯ä¸€ä¸ª9åˆ†ç±»æ•°æ®é›†ï¼Œæˆ‘ä»¬ç°åœ¨æŸ¥çœ‹è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„æ•°æ®ç»“æ„
åˆ†æå®Œæ•°æ®é›†çš„ç»„æˆæƒ…å†µï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦æµ‹è¯•æ¨¡å‹çš„æ€§èƒ½ã€‚æ—¢ç„¶æ˜¯æµ‹è¯•ï¼Œé‚£è‚¯å®šä¸èƒ½ä¸€å¼€å§‹å°±æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½ä¸¢ç»™æ¨¡å‹ï¼Œæˆ‘ä»¬è¦å°æ‰¹é‡çš„æµ‹è¯•ï¼Œè¿™æ—¶å€™å°±ä¼šæ¶‰åŠåˆ°æ•°æ®é›†çš„é‡‡æ ·ï¼Œè¿™ä¸€éƒ¨åˆ†ä¹Ÿéƒ½ä¼šåœ¨æ¨æ–‡ä¸­å’Œå¤§å®¶åˆ†äº«ï¼

æœ€åå°±æ¥åˆ°äº†å¤§å®¶æœ€å…³å¿ƒçš„æ¨¡å‹æ€§èƒ½å¯¹æ¯”å’Œå¯è§†åŒ–åˆ†æéƒ¨åˆ†ï¼Œè¿™æœŸæ¨é€å’Œå¤§å®¶åˆ†äº«ä¸‰ç§æµ‹è¯•æ–¹æ³•â€”â€”çº¿æ€§è¯„ä¼°ã€Kè¿‘é‚»ä»¥åŠåŸå‹ç½‘ç»œï¼Œéƒ¨åˆ†æµ‹è¯•ç»“æœå±•ç¤ºå¦‚ä¸‹ã€‚

æ¨¡å‹
å‡†ç¡®ç‡ï¼ˆaccï¼‰
å¹³è¡¡å‡†ç¡®ç‡ï¼ˆbaccï¼‰
Cohen
's kappaç³»æ•°ï¼ˆkappaï¼‰
åŠ æƒF1å€¼ï¼ˆweighted_f1ï¼‰
knn20
0.969
0.957
0.981
0.969
proto
0.884
0.854
0.910
0.876
å¯è§†åŒ–åˆ†æéƒ¨åˆ†ç»“æœå±•ç¤ºå¦‚ä¸‹ï¼Œæœ‰çš„è€å¸ˆ / åŒå­¦å¯èƒ½ä¼šç–‘æƒ‘ï¼Œä¸ºå•¥å±•ç¤ºpatchï¼Œä»¥åŠä¸ºå•¥æ•°æ®é›†æ˜¯patchå½¢å¼çš„ã€‚
å…¶å®å¾ˆç®€å•ï¼Œå› ä¸ºâ€¦â€¦UNIæ˜¯patchçº§åˆ«çš„åŸºç¡€æ¨¡å‹ï¼Œå“ˆå“ˆï¼Œå¤§å®¶åœ¨çœ‹åç»­çš„æ¨é€æ—¶ä¸€å®šè¦ç‰¢è®°è¿™å¥è¯ï¼

ç±»åˆ«é¢„æµ‹å±•ç¤º
ç±»åˆ«é¢„æµ‹å±•ç¤º
æœ¬æœŸé¡¹ç›®å¤ç°æ¨é€æ¶æ„

ä¸€ã€æ–‡çŒ®æ¦‚è¿°
äºŒã€ç¯å¢ƒé…ç½®
ä¸‰ã€é¡¹ç›®å¤ç°å‡†å¤‡
å››ã€CRC - 100
Kæ•°æ®é›†å¤„ç†
äº”ã€çº¿æ€§æ¨¡å‹è®­ç»ƒå’Œè¯„ä¼°
å…­ã€ROIåŒºåŸŸè¿›è¡ŒKè¿‘é‚»å’ŒåŸå‹ç½‘ç»œçš„è¯„ä¼°
ä¸ƒã€åŸºäºåŸå‹ç½‘ç»œï¼ˆProtoNetï¼‰çš„å°æ ·æœ¬å­¦ä¹ æ€§èƒ½è¯„ä¼°
å…«ã€ProtoNetæ·±å…¥æ¢ç´¢
äº¤æµç¾¤

æ¬¢è¿å¤§å®¶åŠ å…¥ã€åŒ»å­¦AIã€‘äº¤æµç¾¤ï¼Œæœ¬ç¾¤è®¾ç«‹çš„åˆè¡·æ˜¯æä¾›äº¤æµå¹³å°ï¼Œæ–¹ä¾¿å¤§å®¶åç»­è¯¾é¢˜åˆä½œã€‚

ç›®å‰å°ç½—å…¨å¹³å°å…³æ³¨é‡52, 000 +ï¼Œäº¤æµç¾¤æ€»æˆå‘˜1100 +ï¼Œå¤§éƒ¨åˆ†æ¥è‡ªå›½å†…å¤–é¡¶å°–é™¢æ ¡ / åŒ»é™¢ï¼ŒæœŸå¾…æ‚¨çš„åŠ å…¥ï¼ï¼

ç”±äºè¿‘æœŸå…¥ç¾¤æ¨é”€äººå‘˜è¾ƒå¤šï¼Œå·²å¼€å¯å…¥ç¾¤éªŒè¯ï¼Œæ‰«ç æ·»åŠ æˆ‘çš„è”ç³»æ–¹å¼ï¼Œå¤‡æ³¨å§“å - å•ä½ - ç§‘å®¤ / ä¸“ä¸šï¼Œå³å¯é‚€æ‚¨å…¥ç¾¤ã€‚

å›¾ç‰‡
çŸ¥è¯†æ˜Ÿçƒ

å¦‚éœ€è·å–æ¨æ–‡ä¸­æåŠçš„å„ç§èµ„æ–™ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒï¼

å›¾ç‰‡
é˜…å‰å¿…è¯»

æ³¨æ„ï¼Œç”±äºç¼–å†™é¡¹ç›®å¤ç°ç³»åˆ—æ•™ç¨‹éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´ï¼Œæ‰€ä»¥é‡‡å–ä»˜è´¹é˜…è¯»çš„å½¢å¼ï¼Œç»å¯¹è®©ä½ ç‰©è¶…æ‰€å€¼ï¼Œä½ é€šè¿‡è¿™ä¸€ç¯‡æ¨é€ï¼Œå¯ä»¥èŠ‚çœå¤§é‡è‡ªå·±æ‘¸ç´¢çš„æ—¶é—´ã€‚

ã€1ã€‘é˜…è¯»æ–¹å¼1ï¼šçŸ¥è¯†æ˜Ÿçƒï¼ˆæ¨èï¼‰

å·²è®¢é˜…æ˜Ÿçƒç”¨æˆ·å¯ä»¥å‰å¾€çŸ¥è¯†æ˜Ÿçƒè·å–pdfç‰ˆæœ¬æ•™ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ˜Ÿçƒä¸­æé—®ï¼Œæˆ‘ä¼šç»™å‡ºè¯¦ç»†è§£ç­”ã€‚æ­¤å¤–ï¼Œæ˜Ÿçƒæ˜¯æŒ‰å¹´ä»˜è´¹ï¼Œæ›´åˆ’ç®—ï¼

ã€2ã€‘é˜…è¯»æ–¹å¼2ï¼šå¾®ä¿¡æ¨é€ä»˜è´¹é˜…è¯»

å¦‚æœåªå¯¹å•ç¯‡å†…å®¹æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç›´æ¥æ”¯ä»˜æœ¬ç¯‡æ–‡ç« è´¹ç”¨ã€‚

ä¸€ã€æ–‡çŒ®æ¦‚è¿°
1 - 1ï¼šç ”ç©¶èƒŒæ™¯

è®¡ç®—ç—…ç†å­¦ï¼ˆCPathï¼‰éœ€è¦å¯¹ç»„ç»‡å›¾åƒè¿›è¡Œå®šé‡è¯„ä¼°ï¼Œä»¥æ”¯æŒç—…ç†å­¦è¯Šæ–­ã€‚ç„¶è€Œï¼Œå…¨åˆ‡ç‰‡å›¾åƒï¼ˆWSIsï¼‰çš„é«˜åˆ†è¾¨ç‡å’Œå½¢æ€ç‰¹å¾çš„å˜å¼‚æ€§ä½¿å¾—å¤§è§„æ¨¡æ•°æ®æ³¨é‡Šå˜å¾—å›°éš¾ï¼Œé™åˆ¶äº†æ¨¡å‹çš„è®­ç»ƒå’Œæ€§èƒ½ã€‚

å½“å‰æ–¹æ³•é€šå¸¸ä¾èµ–äºä»è‡ªç„¶å›¾åƒæ•°æ®é›†æˆ–å…¬å¼€çš„ç»„ç»‡ç—…ç†å­¦æ•°æ®é›†è¿›è¡Œè¿ç§»å­¦ä¹ ï¼Œä½†è¿™äº›æ–¹æ³•åœ¨ä¸åŒç»„ç»‡ç±»å‹å’Œç–¾ç—…ç±»åˆ«çš„å¹¿æ³›åº”ç”¨ä¸­å­˜åœ¨å±€é™æ€§ã€‚

1 - 2ï¼šç ”ç©¶æ–¹æ³•

æ•°æ®é›†æ„å»ºï¼šæ„å»ºMass - 100
Kæ•°æ®é›†ï¼ŒåŒ…å«è¶…1äº¿ä¸ªç»„ç»‡å›¾åƒå—ï¼Œæ¥è‡ªè¶…10ä¸‡å¼ è¯Šæ–­æ€§H & EæŸ“è‰²WSIsï¼Œæ¶µç›–20ç§ä¸»è¦ç»„ç»‡ç±»å‹ã€‚
åŒæ—¶åˆ›å»ºMass - 22
Kå’ŒMass - 1
Kå­é›†ï¼Œç”¨äºè¯„ä¼°æ•°æ®ç¼©æ”¾å®šå¾‹ã€‚
æ¨¡å‹æ¶æ„ä¸é¢„è®­ç»ƒï¼šåŸºäºè§†è§‰Transformeræ¶æ„ï¼Œä½¿ç”¨DINOv2è‡ªç›‘ç£å­¦ä¹ æ–¹æ³•åœ¨Mass - 100
Kä¸Šé¢„è®­ç»ƒUNIæ¨¡å‹ã€‚å¯¹æ¯”å…¶ä»–è‡ªç›‘ç£å­¦ä¹ ç®—æ³•ï¼ˆå¦‚MoCoV3ï¼‰å’Œä¸åŒæ¨¡å‹æ¶æ„ï¼ˆViT - Baseå’ŒViT - Largeï¼‰ã€‚
è¯„ä¼°è®¾ç½®ï¼šå°†UNIä¸CPathé¢†åŸŸå¸¸ç”¨çš„ä¸‰ä¸ªé¢„è®­ç»ƒç¼–ç å™¨ï¼ˆResNet - 50ã€CTransPathã€REMEDIS ï¼‰å¯¹æ¯”ï¼Œåœ¨34ä¸ªä¸´åºŠä»»åŠ¡ä¸Šè¯„ä¼°ï¼ŒåŒ…æ‹¬å¼±ç›‘ç£åˆ‡ç‰‡åˆ†ç±»ã€ROIåˆ†ç±»ã€æ£€ç´¢ã€åˆ†å‰²å’Œå°‘æ ·æœ¬å­¦ä¹ ç­‰ä»»åŠ¡ã€‚

1 - 3ï¼šç ”ç©¶ç»“æœ
é¢„è®­ç»ƒç¼©æ”¾å®šå¾‹ï¼šUNIå±•ç°å‡ºæ¨¡å‹å’Œæ•°æ®ç¼©æ”¾èƒ½åŠ›ï¼Œéšç€é¢„è®­ç»ƒæ•°æ®å¢åŠ ï¼Œåœ¨OT - 43
å’ŒOT - 108
ä»»åŠ¡ä¸Šæ€§èƒ½æå‡æ˜¾è‘—ï¼Œä¸”ä¼˜äºå…¶ä»–é¢„è®­ç»ƒç¼–ç å™¨ã€‚
å¼±ç›‘ç£åˆ‡ç‰‡åˆ†ç±»ï¼šåœ¨15ä¸ªåˆ‡ç‰‡çº§åˆ†ç±»ä»»åŠ¡ä¸­ï¼ŒUNIè¡¨ç°ä¼˜å¼‚ï¼Œå°¤å…¶åœ¨ç½•è§ç™Œç—‡ç±»å‹æˆ–é«˜è¯Šæ–­å¤æ‚æ€§ä»»åŠ¡ä¸Šä¼˜åŠ¿æ˜æ˜¾ï¼Œéƒ¨åˆ†ç»“æœè¶…è¿‡äººç±»ç—…ç†å­¦å®¶è¡¨ç°ã€‚
å°‘æ ·æœ¬å­¦ä¹ ï¼šåœ¨å°‘æ ·æœ¬å­¦ä¹ ä»»åŠ¡ä¸­ï¼ŒUNIæ ‡ç­¾æ•ˆç‡é«˜ï¼Œåœ¨åˆ‡ç‰‡çº§å’ŒROIçº§åˆ†ç±»ä¸­ï¼Œç›¸æ¯”å…¶ä»–ç¼–ç å™¨ï¼Œèƒ½ç”¨æ›´å°‘è®­ç»ƒæ ·æœ¬è¾¾åˆ°æ›´é«˜æ€§èƒ½ã€‚
å…¶ä»–ä»»åŠ¡è¡¨ç°ï¼šåœ¨ROIåˆ†ç±»ã€æ£€ç´¢ã€ç»†èƒç±»å‹åˆ†å‰²ç­‰ä»»åŠ¡ä¸­ï¼ŒUNIå‡ä¼˜äºå¤šæ•°åŸºçº¿æ¨¡å‹ï¼Œå¯¹é«˜åˆ†è¾¨ç‡å›¾åƒå…·æœ‰é²æ£’æ€§ã€‚

äºŒã€ç¯å¢ƒé…ç½®
2 - 1ï¼šç¯å¢ƒé…ç½®

# å…‹éš†ä»“åº“å¹¶è¿›å…¥ç›®å½•
git
clone
https: // github.com / mahmoodlab / UNI.git
cd
UNI

# åˆ›å»ºcondaç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
conda
create - n
UNI
python = 3.10 - y
conda
activate
UNI
pip
install - e.

# å®‰è£…é¢å¤–ä¾èµ–
pip
install
timm
huggingface_hub
torchvision

1ã€è®¿é—®HuggingFaceæ¨¡å‹é¡µé¢(https: // huggingface.co / MahmoodLab / UNI2 - h)

image - 20250314120025550
image - 20250314120025550
2ã€ç™»å½•HuggingFaceè´¦å·ï¼ˆéœ€å…ˆæ³¨å†Œï¼‰

3ã€ç”³è¯·æ¨¡å‹è®¿é—®æƒé™ï¼ˆéœ€å¡«å†™ä½¿ç”¨ç›®çš„ï¼‰

4ã€é…ç½®Token

image - 20250314120406673
image - 20250314120406673
ç„¶åé€‰æ‹©æ¨¡å‹ã€‚

image - 20250314120456254
image - 20250314120456254
æ³¨æ„å¤åˆ¶Tokenï¼Œåç»­è¦ç”¨åˆ°ã€‚

image - 20250314120549016
image - 20250314120549016

ä¸‰ã€é¡¹ç›®å¤ç°å‡†å¤‡
3 - 1ï¼šå¯¼å…¥ä¾èµ–é¡¹

1.åŸºç¡€åº“å¯¼å…¥
import torch
import torchvision
import os
from os.path import join as j_
from PIL import Image
import pandas as pd
import numpy as np

ä½œç”¨ï¼šå¯¼å…¥æ·±åº¦å­¦ä¹ æ¡†æ¶å’Œæ•°æ®å¤„ç†å·¥å…·

å…³é”®ç‚¹ï¼š
torch / torchvisionï¼šPyTorchæ ¸å¿ƒåº“å’Œè§†è§‰æ‰©å±•
osï¼šæ“ä½œç³»ç»Ÿçº§æ–‡ä»¶è·¯å¾„æ“ä½œ
PIL.Imageï¼šå›¾åƒè¯»å–ä¸å¤„ç†
pandas / numpyï¼šç»“æ„åŒ–æ•°æ®æ“ä½œ

2.UNIä¸“ç”¨æ¨¡å—å¯¼å…¥
from uni import get_encoder
from uni.downstream.extract_patch_features import extract_patch_features_from_dataloader
from uni.downstream.eval_patch_features.linear_probe import eval_linear_probe
from uni.downstream.eval_patch_features.fewshot import eval_knn, eval_fewshot
from uni.downstream.eval_patch_features.protonet import ProtoNet, prototype_topk_vote
from uni.downstream.eval_patch_features.metrics import get_eval_metrics, print_metrics
from uni.downstream.utils import concat_images

æ ¸å¿ƒç»„ä»¶ï¼š
æ¨¡å— / å‡½æ•°
åŠŸèƒ½
get_encoder
åŠ è½½é¢„è®­ç»ƒçš„UNIæ¨¡å‹
extract_patch_features_from_dataloader
æ‰¹é‡æå–å›¾åƒç‰¹å¾
eval_linear_probe
çº¿æ€§åˆ†ç±»è¯„ä¼°
eval_knn/ eval_fewshot
Kè¿‘é‚» / å°æ ·æœ¬å­¦ä¹ è¯„ä¼°
ProtoNet
åŸå‹ç½‘ç»œå®ç°
get_eval_metrics
è®¡ç®—åˆ†ç±»æŒ‡æ ‡

3.è®¾å¤‡é…ç½®
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
ä½œç”¨ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶é…ç½®è®¡ç®—è®¾å¤‡

3 - 2ï¼šåŠ è½½é¢„è®­ç»ƒçš„UNI2 - hæ¨¡å‹

1.åŠŸèƒ½æ¦‚è¿°
ä¸‹è½½æ¨¡å‹æƒé‡ï¼šget_encoder
å‡½æ•°ä¼šè‡ªåŠ¨ä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½UNI2 - hçš„é¢„è®­ç»ƒæƒé‡ï¼Œä¿å­˜åˆ°æœ¬åœ°ç›®å½•. / assets / ckpts /ã€‚
åˆ›å»ºæ¨¡å‹å®ä¾‹ï¼šåŠ è½½ä¸‹è½½çš„æƒé‡ï¼Œæ„å»ºå¹¶è¿”å›æ¨¡å‹å¯¹è±¡ã€‚
è·å–é¢„å¤„ç†æ–¹æ³•ï¼šè¿”å›ä¸æ¨¡å‹åŒ¹é…çš„å›¾åƒé¢„å¤„ç†æµç¨‹ï¼ˆtransformï¼‰ï¼Œç¡®ä¿è¾“å…¥æ•°æ®ç¬¦åˆæ¨¡å‹è¦æ±‚ã€‚

2.ä»£ç 
pip install ipywidgets
import os
os.environ["HF_ENDPOINT"] = "https://hf-mirror.com"

from huggingface_hub import login
login(token="â€¦â€¦")

from uni import get_encoder  # ä»uniæ¨¡å—å¯¼å…¥get_encoderå‡½æ•°
model, transform = get_encoder(enc_name='uni2-h', device=device)

è¡¥å……

å¦‚æœä½ è·Ÿç€ä¸Šé¢çš„æ•™ç¨‹èµ°ï¼Œä¸€ç›´æŠ¥é”™ï¼Œä¹Ÿä¸è¦ç´§ï¼Œæ–°å»ºä¸€ä¸ªè„šæœ¬ï¼Œç„¶åæŠŠä¸Šé¢æ‰€æœ‰çš„ä»£ç éƒ½æ”¾è¿›è„šæœ¬é‡Œï¼Œç„¶ååœ¨ç»ˆç«¯è¿è¡Œã€‚

image - 20250314154827185
image - 20250314154827185
é¦–å…ˆä½ éœ€è¦è¾“å…¥ä¸€ä¸ªtokenï¼Œç„¶åå†è¾“å…¥ä¸€ä¸ªyï¼Œå°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚

å››ã€CRC - 100
Kæ•°æ®é›†å¤„ç†
æµç¨‹æ€»ç»“

æ•°æ®å‡†å¤‡ï¼šåŠ è½½ç—…ç†å›¾åƒæ•°æ®é›†å¹¶åˆ†æ‰¹æ¬¡å¤„ç†ã€‚
ç‰¹å¾æå–ï¼šç”¨é¢„è®­ç»ƒæ¨¡å‹æå–å›¾åƒå—çš„é«˜ç»´ç‰¹å¾ï¼ˆè¿ç§»å­¦ä¹ å¸¸è§æ“ä½œï¼‰ã€‚
æ ¼å¼è½¬æ¢ï¼šå°†ç‰¹å¾å’Œæ ‡ç­¾è½¬æ¢ä¸ºPyTorchå¼ é‡ï¼Œä¾›åç»­è®­ç»ƒåˆ†ç±»å™¨ä½¿ç”¨ã€‚
æ€§èƒ½è¯„ä¼°ï¼šç»Ÿè®¡è€—æ—¶ï¼Œä¼˜åŒ–æ•°æ®å¤„ç†æ•ˆç‡ã€‚
é€‚ç”¨äºåŒ»å­¦å›¾åƒåˆ†ç±»ã€æ£€ç´¢ç­‰ä¸‹æ¸¸ä»»åŠ¡ï¼Œé¿å…åœ¨æ¯æ¬¡è®­ç»ƒæ—¶é‡å¤è®¡ç®—ç‰¹å¾ã€‚

4 - 1ï¼šæ•°æ®é›†é¢„å¤„ç†

1ã€ä¸‹è½½æ•°æ®é›†
è¿™ä¸€éƒ¨åˆ†æŒ‡ä»¤åœ¨ç»ˆç«¯å®Œæˆã€‚

è®­ç»ƒé›† (100Kå›¾åƒ)
nohup wget https://zenodo.org/records/1214456/files/NCT-CRC-HE-100K-NONORM.zip?download=1 -O NCT-CRC-HE-100K-NONORM.zip > output.logcrc1 2>&1 &
æµ‹è¯•é›† (7.18Kå›¾åƒ)
nohup wget https://zenodo.org/records/1214456/files/CRC-VAL-HE-7K.zip?download=1 -O CRC-VAL-HE-7K.zip > output.logcrc2 2>&1 &

# åˆ›å»ºç›®æ ‡ç›®å½•
mkdir -p ./assets/data/CRC100K/
# è§£å‹æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
unzip NCT-CRC-HE-100K-NONORM.zip -d ./assets/data/CRC100K/
unzip CRC-VAL-HE-7K.zip -d ./assets/data/CRC100K/



3ã€å®šä¹‰æ•°æ®é¢„å¤„ç†ä¸åŠ è½½
å¯¼å…¥ä¾èµ–åº“
import time  # ç”¨äºè®¡æ—¶ï¼Œè®¡ç®—ä»£ç æ‰§è¡Œæ—¶é—´
from uni.downstream.extract_patch_features import extract_patch_features_from_dataloader  # ä»è‡ªå®šä¹‰æ¨¡å—å¯¼å…¥ç‰¹å¾æå–å‡½æ•°

åˆå§‹åŒ–è®¡æ—¶å’Œæ•°æ®è·¯å¾„
start = time.time()  # è®°å½•ä»£ç å¼€å§‹æ‰§è¡Œçš„æ—¶é—´æˆ³
dataroot = './assets/data/CRC100K/'  # æ•°æ®é›†æ ¹ç›®å½•ï¼ŒæŒ‡å‘ç»“ç›´è‚ ç™Œç—…ç†å›¾åƒæ•°æ®é›†ï¼ˆCRC100Kï¼‰
åˆ›å»ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†æ•°æ®é›†
# ä½¿ç”¨ImageFolderåŠ è½½å›¾åƒæ•°æ®é›†ï¼ˆå‡è®¾j_æ˜¯è·¯å¾„æ‹¼æ¥å‡½æ•°ï¼Œç±»ä¼¼os.path.joinï¼‰
train_dataset = torchvision.datasets.ImageFolder(
    j_(dataroot, 'NCT-CRC-HE-100K-NONORM'),  # è®­ç»ƒé›†è·¯å¾„ï¼šdataroot/NCT-CRC-HE-100K-NONORM
    transform=transform  # å›¾åƒé¢„å¤„ç†ï¼ˆå¦‚å½’ä¸€åŒ–ã€è£å‰ªç­‰ï¼Œå‡è®¾transformå·²å®šä¹‰ï¼‰
)
test_dataset = torchvision.datasets.ImageFolder(
    j_(dataroot, 'CRC-VAL-HE-7K'),  # æµ‹è¯•é›†è·¯å¾„ï¼šdataroot/CRC-VAL-HE-7K
    transform=transform  # ä½¿ç”¨ä¸è®­ç»ƒé›†ç›¸åŒçš„é¢„å¤„ç†
)
åˆ›å»ºæ•°æ®åŠ è½½å™¨ï¼ˆDataLoaderï¼‰
train_dataloader = torch.utils.data.DataLoader(
    train_dataset,
    batch_size=256,  # æ¯æ‰¹æ¬¡åŠ è½½256å¼ å›¾åƒ
    shuffle=False,  # ä¸éšæœºæ‰“ä¹±æ•°æ®ï¼ˆä¿æŒé¡ºåºä¸€è‡´ï¼Œå¯èƒ½ç”¨äºåç»­ç‰¹å¾å¯¹é½ï¼‰
    num_workers=16  # ä½¿ç”¨16ä¸ªå­è¿›ç¨‹åŠ é€Ÿæ•°æ®åŠ è½½
)
test_dataloader = torch.utils.data.DataLoader(
    test_dataset,
    batch_size=256,  # æµ‹è¯•é›†åŒæ ·æ‰¹é‡å¤„ç†256å¼ 
    shuffle=False,  # æµ‹è¯•é›†é€šå¸¸æ— éœ€æ‰“ä¹±
    num_workers=16
)
æå–å›¾åƒå—ç‰¹å¾
# è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°æå–ç‰¹å¾
train_features = extract_patch_features_from_dataloader(model,
                                                        train_dataloader)  # è¿”å›å­—å…¸ï¼š{"embeddings": [...], "labels": [...]}
test_features = extract_patch_features_from_dataloader(model, test_dataloader)
è½¬æ¢ä¸ºPyTorchå¼ é‡
# å°†ç‰¹å¾å’Œæ ‡ç­¾ä»NumPyæ•°ç»„è½¬æ¢ä¸ºPyTorchå¼ é‡
train_feats = torch.Tensor(train_features['embeddings'])  # è®­ç»ƒé›†ç‰¹å¾å¼ é‡ï¼ˆå½¢çŠ¶ï¼š[æ ·æœ¬æ•°, ç‰¹å¾ç»´åº¦]ï¼‰
train_labels = torch.Tensor(train_features['labels']).type(torch.long)  # æ ‡ç­¾è½¬æ¢ä¸ºæ•´å‹ï¼ˆåˆ†ç±»ä»»åŠ¡è¦æ±‚ï¼‰

test_feats = torch.Tensor(test_features['embeddings'])  # æµ‹è¯•é›†ç‰¹å¾å¼ é‡
test_labels = torch.Tensor(test_features['labels']).type(torch.long)
è®¡ç®—å¹¶è¾“å‡ºæ€»è€—æ—¶
elapsed = time.time() - start  # è®¡ç®—æ€»æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
print(f'Took {elapsed:.03f} seconds')  # æ ¼å¼åŒ–è¾“å‡ºï¼ˆä¿ç•™3ä½å°æ•°ï¼‰
4 - 2ï¼šæ•°æ®é›†ç²¾ç®€ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ é‡‡ç”¨åŸå§‹çš„æ•°æ®é›†ï¼Œä¸åšä»»ä½•æ”¹åŠ¨ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿™ä¸€æ­¥çš„æ—¶å€™ä¼šçœ‹åˆ°ä¸€ä¸ªè¿›åº¦æ¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

image - 20250317170432609
image - 20250317170432609
è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼ŒCRC - 100
Kæ•°æ®é›†çš„è®­ç»ƒé›†æ€»å…±æœ‰100Kï¼Œ391 * 256 = 100, 0
96 ï¼›æµ‹è¯•é›†æœ‰7
.8
Kï¼Œ29
x256 = 7524ã€‚

ä½†æ˜¯æˆ‘è¿™ä¸ªæ¨é€åªä½œä¸ºæ¼”ç¤ºæ•™ç¨‹ï¼Œå¦‚æœæŒ‰ç…§åŸæ•°æ®é›†å¤§å°è¿›è¡Œå¤„ç†ï¼Œè€—æ—¶è¿‡é•¿ï¼Œæ‰€ä»¥æˆ‘ä¼šå¯¹æ•°æ®åšä¸€äº›ç²¾ç®€ã€‚

æ­£å¥½æ¥ç€è¿™ä¸ªæœºä¼šï¼Œä¹Ÿå’Œå¤§å®¶å±•ç¤ºä¸€ä¸‹ï¼Œæ‹¿åˆ°ä¸€ä¸ªæ–°çš„æ•°æ®é›†ï¼Œåº”è¯¥å¦‚ä½•åˆ†ææ•°æ®é›†çš„ç»„æˆï¼Œå¹¶æ•´ç†è‡ªå·±çš„å®éªŒæ•°æ®ã€‚

é¦–å…ˆæˆ‘ä»¬å†™ä¸€æ®µä»£ç ï¼Œæå–åŸå§‹æ•°æ®é›†çš„æ–‡ä»¶åˆ—è¡¨ï¼Œè®¡ç®—æ¯ä¸ªç±»åˆ«æ•°æ®çš„æ•°é‡ï¼Œæœ€ç»ˆç»“æœæ•´ç†ä¸ºä¸‹å›¾çš„å½¢å¼ã€‚

ä»£ç åœ¨çŸ¥è¯†æ˜Ÿçƒçš„test.ipynbæ–‡ä»¶ä¸­è·å–
ä»£ç åœ¨çŸ¥è¯†æ˜Ÿçƒçš„test.ipynbæ–‡ä»¶ä¸­è·å–
ç”±äºæˆ‘ä»¬æ­¤å¤„ä¸éœ€è¦è€ƒè™‘æ•°æ®ä¸å¹³è¡¡çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ç®€å•ç²—æš´çš„ç›´æ¥å¯¹100Kæ•°æ®ä¸‹é‡‡æ ·ä¸º10Kï¼Œ7
Kæ•°æ®ä¸åšå˜åŠ¨ï¼Œæ­£å¥½ç»™å¤§å®¶å±•ç¤ºä¸€ä¸‹è®­ç»ƒé›†æ•°é‡å¤§å°å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“ã€‚

ä¸‹é‡‡æ ·çš„ä»£ç å¦‚ä¸‹ï¼Œå¤§å®¶è®°å¾—å¯¹åº”ä¿®æ”¹åˆ›å»ºæ•°æ®é›†çš„è·¯å¾„ã€‚

è·¯å¾„ä¿®æ”¹
è·¯å¾„ä¿®æ”¹
import os
import shutil
import random


def sample_and_copy_tif_images(src_root, dst_root, sample_num=10):
    """
    ä»æºè·¯å¾„çš„æ¯ä¸ªå­æ–‡ä»¶å¤¹ä¸­éšæœºæŠ½å–æŒ‡å®šæ•°é‡çš„.tifæ–‡ä»¶ï¼Œä¿æŒåŸç»“æ„å¤åˆ¶åˆ°ç›®æ ‡è·¯å¾„
    """
    # ç¡®ä¿ç›®æ ‡æ ¹ç›®å½•å­˜åœ¨
    os.makedirs(dst_root, exist_ok=True)

    # éå†æºç›®å½•ä¸‹çš„æ‰€æœ‰å­æ–‡ä»¶å¤¹
    for folder_name in os.listdir(src_root):
        src_folder = os.path.join(src_root, folder_name)

        # è·³è¿‡éç›®å½•æ–‡ä»¶
        ifnot
        os.path.isdir(src_folder):
        continue

    # è·å–æ‰€æœ‰.tifæ–‡ä»¶
    tif_files = [
        f for f in os.listdir(src_folder)
        if f.lower().endswith(".tif")
    ]

    # æ£€æŸ¥æ–‡ä»¶æ•°é‡
    if len(tif_files) < sample_num:
        raise ValueError(f"æ–‡ä»¶å¤¹ {folder_name} ä¸­åªæœ‰ {len(tif_files)} ä¸ª.tifæ–‡ä»¶ï¼Œä¸è¶³è¦æ±‚çš„ {sample_num} ä¸ª")

    # éšæœºæŠ½æ ·
    selected_files = random.sample(tif_files, sample_num)

    # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
    dst_folder = os.path.join(dst_root, folder_name)
    os.makedirs(dst_folder, exist_ok=True)

    # å¤åˆ¶æ–‡ä»¶
    for file_name in selected_files:
        src_path = os.path.join(src_folder, file_name)
        dst_path = os.path.join(dst_folder, file_name)
        shutil.copy(src_path, dst_path)
        print(f"å·²å¤åˆ¶: {src_path} -> {dst_path}")


if __name__ == "__main__":
    # åŸå§‹è·¯å¾„ï¼ˆåŒ…å«9ä¸ªå­æ–‡ä»¶å¤¹ï¼‰
    source_path = "/data2/data2_mailab015/reproject/2025/03/03-14/UNI/assets/data/CRC100K/NCT-CRC-HE-100K-NONORM"

    # æ–°è·¯å¾„ï¼ˆå°†è‡ªåŠ¨åˆ›å»ºï¼‰
    destination_path = "/data2/data2_mailab015/reproject/2025/03/03-14/UNI/assets/data2/CRC100K/NCT-CRC-HE-100K-NONORM"

    # æ‰§è¡ŒæŠ½æ ·å’Œå¤åˆ¶
    sample_and_copy_tif_images(
        src_root=source_path,
        dst_root=destination_path,
        sample_num=1000
    )
äº”ã€çº¿æ€§æ¨¡å‹è®­ç»ƒå’Œè¯„ä¼°
æµç¨‹æ€»ç»“

è¾“å…¥ï¼šè®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„é¢„æå–ç‰¹å¾åŠæ ‡ç­¾ã€‚
è®­ç»ƒï¼šåœ¨è®­ç»ƒé›†ä¸Šè®­ç»ƒçº¿æ€§åˆ†ç±»å™¨ï¼ˆå¦‚é€»è¾‘å›å½’ï¼‰ã€‚
è¯„ä¼°ï¼šåœ¨æµ‹è¯•é›†ä¸Šè®¡ç®—åˆ†ç±»æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚å‡†ç¡®ç‡ï¼‰ã€‚
è¾“å‡ºï¼šæ ¼å¼åŒ–æ˜¾ç¤ºç»“æœï¼ŒéªŒè¯ç‰¹å¾çš„æœ‰æ•ˆæ€§ã€‚
è¯¥ä»£ç æ˜¯è¿ç§»å­¦ä¹ æµç¨‹çš„æœ€åä¸€æ­¥ï¼Œç”¨äºéªŒè¯ç‰¹å¾æå–æ¨¡å‹ï¼ˆå¦‚é¢„è®­ç»ƒçš„ResNetï¼‰åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„å®ç”¨æ€§ã€‚

5 - 1ï¼šä»»åŠ¡è¯´æ˜

ROI
Linear
Probe
Evaluation.  # æ³¨é‡Šï¼šè¡¨ç¤ºè¿™æ˜¯é’ˆå¯¹æ„Ÿå…´è¶£åŒºåŸŸï¼ˆROIï¼‰çš„çº¿æ€§æ¢æµ‹è¯„ä¼°ä»»åŠ¡
ROIï¼šåœ¨åŒ»å­¦å›¾åƒä¸­é€šå¸¸æŒ‡â€œæ„Ÿå…´è¶£åŒºåŸŸâ€ï¼ˆRegion
of
Interestï¼‰ï¼Œä¾‹å¦‚è‚¿ç˜¤åŒºåŸŸã€‚
Linear
Probeï¼šé€šè¿‡è®­ç»ƒçº¿æ€§åˆ†ç±»å™¨ï¼ˆå¦‚é€»è¾‘å›å½’ï¼‰è¯„ä¼°ç‰¹å¾çš„è´¨é‡ï¼Œæµ‹è¯•å…¶çº¿æ€§å¯åˆ†æ€§ã€‚
5 - 2ï¼šå¯¼å…¥è¯„ä¼°å‡½æ•°

from uni.downstream.eval_patch_features.linear_probe import eval_linear_probe
** eval_linear_probe **ï¼šä»è‡ªå®šä¹‰æ¨¡å—å¯¼å…¥çš„å‡½æ•°ï¼Œç”¨äºåœ¨æå–çš„ç‰¹å¾ä¸Šè®­ç»ƒçº¿æ€§åˆ†ç±»å™¨å¹¶è¯„ä¼°æ€§èƒ½ã€‚

5 - 3ï¼šæ‰§è¡Œçº¿æ€§æ¢æµ‹è¯„ä¼°

linprobe_eval_metrics, linprobe_dump = eval_linear_probe(
    train_feats=train_feats,  # è®­ç»ƒé›†ç‰¹å¾å¼ é‡ï¼ˆæ¥è‡ªå‰ä¸€æ­¥çš„ç‰¹å¾æå–ï¼‰
    train_labels=train_labels,  # è®­ç»ƒé›†æ ‡ç­¾å¼ é‡
    valid_feats=None,  # æœªæä¾›éªŒè¯é›†ç‰¹å¾ï¼ˆå¯èƒ½ç›´æ¥ä½¿ç”¨è®­ç»ƒé›†è®­ç»ƒï¼‰
    valid_labels=None,  # æœªæä¾›éªŒè¯é›†æ ‡ç­¾
    test_feats=test_feats,  # æµ‹è¯•é›†ç‰¹å¾å¼ é‡
    test_labels=test_labels,  # æµ‹è¯•é›†æ ‡ç­¾å¼ é‡
    max_iter=1000,  # çº¿æ€§æ¨¡å‹çš„æœ€å¤§è®­ç»ƒè¿­ä»£æ¬¡æ•°ï¼ˆé˜²æ­¢ä¸æ”¶æ•›ï¼‰
    verbose=True,  # è¾“å‡ºè®­ç»ƒè¿‡ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚æŸå¤±å˜åŒ–ï¼‰
)
è¾“å…¥å‚æ•°

train_feats / test_featsï¼šä»é¢„è®­ç»ƒæ¨¡å‹æå–çš„ç‰¹å¾ï¼Œå½¢çŠ¶ä¸º[æ ·æœ¬æ•°, ç‰¹å¾ç»´åº¦]ã€‚
valid_featsï¼šéªŒè¯é›†æœªæä¾›ï¼Œå¯èƒ½ç›´æ¥ä½¿ç”¨æµ‹è¯•é›†è¯„ä¼°æˆ–è·³è¿‡è¶…å‚æ•°è°ƒä¼˜ã€‚
max_iter = 1000ï¼šæ§åˆ¶çº¿æ€§æ¨¡å‹ï¼ˆå¦‚
sklearn
çš„
LogisticRegressionï¼‰çš„æœ€å¤§è¿­ä»£æ¬¡æ•°ã€‚
verbose = Trueï¼šè¾“å‡ºè®­ç»ƒæ—¥å¿—ï¼Œä¾‹å¦‚æ¯ä¸ªepochçš„æŸå¤±å€¼æˆ–è¿›åº¦æ¡ã€‚
è¾“å‡ºç»“æœ

linprobe_eval_metricsï¼šè¯„ä¼°æŒ‡æ ‡å­—å…¸ï¼ˆå¦‚å‡†ç¡®ç‡ã€F1åˆ†æ•°ã€AUCï¼‰ã€‚
linprobe_dumpï¼šå¯èƒ½åŒ…å«æ¨¡å‹æƒé‡ã€é¢„æµ‹ç»“æœç­‰è¯¦ç»†æ•°æ®ï¼ˆæœªåœ¨åç»­ä»£ç ä¸­ä½¿ç”¨ï¼‰ã€‚
6 - 4ï¼šæ‰“å°è¯„ä¼°æŒ‡æ ‡

print_metrics(linprobe_eval_metrics)  # è‡ªå®šä¹‰å‡½æ•°ï¼Œæ ¼å¼åŒ–è¾“å‡ºè¯„ä¼°ç»“æœ
çº¿æ€§æ¨¡å‹è¯„ä¼°ï¼ˆLinear
Probe
Evaluationï¼‰ç»“æœ
çº¿æ€§æ¨¡å‹è¯„ä¼°ï¼ˆLinear
Probe
Evaluationï¼‰ç»“æœ
æ•°æ®é›†å½¢çŠ¶ï¼š
è®­ç»ƒé›†å½¢çŠ¶ä¸ºtorch.Size([100000, 1536]) ï¼Œè¡¨ç¤ºè®­ç»ƒé›†æœ‰100000ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬ç‰¹å¾ç»´åº¦ä¸º1536ã€‚
æµ‹è¯•é›†å½¢çŠ¶ä¸ºtorch.Size([7180, 1536]) ï¼Œå³æµ‹è¯•é›†æœ‰7180ä¸ªæ ·æœ¬ï¼Œç‰¹å¾ç»´åº¦åŒæ ·ä¸º1536ã€‚
è®­ç»ƒç›¸å…³æŒ‡æ ‡ï¼š
è®­ç»ƒè¿‡ç¨‹ä¸­çš„æœ€ä½³æˆæœ¬ï¼ˆBest
costï¼‰ä¸º138
.240ã€‚
è®­ç»ƒå‰æŸå¤±ï¼ˆLossï¼‰ä¸º2
.197 ï¼Œè®­ç»ƒåæŸå¤±é™ä½åˆ°0
.030ï¼Œè¯´æ˜æ¨¡å‹è®­ç»ƒæ•ˆæœæ˜¾è‘—ï¼Œå¾ˆå¥½åœ°æ‹Ÿåˆäº†è®­ç»ƒæ•°æ®ã€‚
æµ‹è¯•ç›¸å…³æŒ‡æ ‡ï¼š
æµ‹è¯•æ—¶é—´çš„å½¢çŠ¶ä¸å‰é¢æµ‹è¯•é›†å½¢çŠ¶ä¸€è‡´ã€‚
çº¿æ€§æ¢é’ˆè¯„ä¼°æ€»è€—æ—¶4
.95ï¼ˆæœªæ˜ç¡®æ—¶é—´å•ä½ï¼Œæ¨æµ‹æ˜¯ç§’ï¼‰ã€‚
æµ‹è¯•å‡†ç¡®ç‡ï¼ˆlin_accï¼‰ä¸º0
.969ã€‚
æµ‹è¯•å¹³è¡¡å‡†ç¡®ç‡ï¼ˆlin_baccï¼‰ä¸º0
.957ã€‚
æµ‹è¯•Cohen
's kappaç³»æ•°ï¼ˆlin_kappaï¼‰ä¸º0.988 ï¼Œè¡¨ç¤ºæ¨¡å‹é¢„æµ‹ç»“æœä¸å®é™…ç»“æœçš„ä¸€è‡´æ€§å¾ˆé«˜ã€‚
æµ‹è¯•åŠ æƒF1å€¼ï¼ˆlin_weighted_f1ï¼‰ä¸º0
.969ã€‚
æµ‹è¯•æ›²çº¿ä¸‹é¢ç§¯ï¼ˆlin_aurocï¼‰ä¸º0
.989 ï¼Œè¯´æ˜æ¨¡å‹åŒºåˆ†æ­£è´Ÿæ ·æœ¬çš„èƒ½åŠ›å¾ˆå¼ºã€‚ æ€»ä½“æ¥çœ‹ï¼Œè¯¥æ¨¡å‹åœ¨æµ‹è¯•é›†ä¸Šè¡¨ç°éå¸¸ä¼˜ç§€ã€‚
5 - 5ï¼š10
Kæ•°æ®ğŸ†š100
Kæ•°æ®

å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘æåˆ°æˆ‘å¯¹æ•°æ®åšäº†ä¸€ä¸ªç²¾ç®€ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹æ•ˆæœã€‚

image - 20250317203051859
image - 20250317203051859
å…­ã€ROIåŒºåŸŸè¿›è¡ŒKè¿‘é‚»å’ŒåŸå‹ç½‘ç»œçš„è¯„ä¼°
æµç¨‹æ€»ç»“

è¾“å…¥ï¼šå·²æå–çš„è®­ç»ƒé›†å’Œæµ‹è¯•é›†ç‰¹å¾ã€‚
é¢„å¤„ç†ï¼šä¸­å¿ƒåŒ–å’Œå½’ä¸€åŒ–ç‰¹å¾ã€‚
KNNè¯„ä¼°ï¼šåŸºäºæœ€è¿‘é‚»æŠ•ç¥¨åˆ†ç±»ã€‚
ProtoNetè¯„ä¼°ï¼šåŸºäºç±»åˆ«åŸå‹åˆ†ç±»ã€‚
è¾“å‡ºï¼šä¸¤ç§æ–¹æ³•çš„åˆ†ç±»æ€§èƒ½æŒ‡æ ‡ã€‚
6 - 1ï¼šä»»åŠ¡è¯´æ˜

ROI
KNN and ProtoNet
evaluation.  # æ³¨é‡Šï¼šè¡¨ç¤ºè¿™æ˜¯é’ˆå¯¹æ„Ÿå…´è¶£åŒºåŸŸï¼ˆROIï¼‰çš„Kè¿‘é‚»ï¼ˆKNNï¼‰å’ŒåŸå‹ç½‘ç»œï¼ˆProtoNetï¼‰è¯„ä¼°
KNNï¼šåŸºäºç‰¹å¾ç©ºé—´ä¸­çš„æœ€è¿‘é‚»åˆ†ç±»ï¼Œç”¨äºè¯„ä¼°ç‰¹å¾çš„å¯åˆ†æ€§ã€‚
ProtoNetï¼šåŸå‹ç½‘ç»œï¼ˆPrototypical
Networkï¼‰ï¼Œå°æ ·æœ¬å­¦ä¹ çš„ç»å…¸æ–¹æ³•ï¼Œé€šè¿‡è®¡ç®—ç±»åˆ«åŸå‹è¿›è¡Œåˆ†ç±»ã€‚
6 - 2ï¼šå¯¼å…¥è¯„ä¼°å‡½æ•°

from uni.downstream.eval_patch_features.fewshot import eval_knn  # ä»è‡ªå®šä¹‰æ¨¡å—å¯¼å…¥è¯„ä¼°å‡½æ•°

6 - 3ï¼šæ‰§è¡ŒKNNå’ŒProtoNetè¯„ä¼°

knn_eval_metrics, knn_dump, proto_eval_metrics, proto_dump = eval_knn(
    train_feats=train_feats,  # è®­ç»ƒé›†ç‰¹å¾å¼ é‡ï¼ˆå½¢çŠ¶ï¼š[æ ·æœ¬æ•°, ç‰¹å¾ç»´åº¦]ï¼‰
    train_labels=train_labels,  # è®­ç»ƒé›†æ ‡ç­¾å¼ é‡ï¼ˆå½¢çŠ¶ï¼š[æ ·æœ¬æ•°]ï¼‰
    test_feats=test_feats,  # æµ‹è¯•é›†ç‰¹å¾å¼ é‡
    test_labels=test_labels,  # æµ‹è¯•é›†æ ‡ç­¾å¼ é‡
    center_feats=True,  # å¯¹ç‰¹å¾è¿›è¡Œä¸­å¿ƒåŒ–ï¼ˆå‡å»å‡å€¼ï¼‰
    normalize_feats=True,  # å¯¹ç‰¹å¾è¿›è¡ŒL2å½’ä¸€åŒ–ï¼ˆå•ä½å‘é‡åŒ–ï¼‰
    n_neighbors=20  # KNNä¸­ä½¿ç”¨çš„è¿‘é‚»æ•°é‡
)
è¾“å…¥å‚æ•°ï¼š

center_feats = Trueï¼šå°†ç‰¹å¾ä¸­å¿ƒåŒ–ï¼ˆä½¿ç‰¹å¾å‡å€¼ä¸º0ï¼‰ï¼Œæ¶ˆé™¤å…¨å±€åå·®ã€‚
normalize_feats = Trueï¼šå¯¹ç‰¹å¾å‘é‡è¿›è¡ŒL2å½’ä¸€åŒ–ï¼ˆæ¯ä¸ªå‘é‡ç¼©æ”¾åˆ°é•¿åº¦ä¸º1ï¼‰ï¼Œä½¿è·ç¦»è®¡ç®—ä¸å—ç‰¹å¾å°ºåº¦å½±å“ã€‚
n_neighbors = 20ï¼šKNNåˆ†ç±»æ—¶è€ƒè™‘æœ€è¿‘çš„20ä¸ªé‚»å±…ï¼ˆå€¼è¶Šå¤§æŠ—å™ªæ€§è¶Šå¼ºï¼Œä½†å¯èƒ½æ¨¡ç³Šç±»åˆ«è¾¹ç•Œï¼‰ã€‚
è¾“å‡ºç»“æœï¼š

knn_eval_metricsï¼šKNNçš„è¯„ä¼°æŒ‡æ ‡ï¼ˆå¦‚å‡†ç¡®ç‡ã€å¬å›ç‡ï¼‰ã€‚
knn_dumpï¼šå¯èƒ½åŒ…å«KNNé¢„æµ‹ç»“æœæˆ–ä¸­é—´æ•°æ®ã€‚
proto_eval_metricsï¼šProtoNetçš„è¯„ä¼°æŒ‡æ ‡ã€‚
proto_dumpï¼šProtoNetçš„è¯¦ç»†è¾“å‡ºï¼ˆå¦‚åŸå‹å‘é‡ã€é¢„æµ‹ç»“æœï¼‰ã€‚
6 - 4ï¼šæ‰“å°è¯„ä¼°ç»“æœ

print_metrics(knn_eval_metrics)  # è¾“å‡ºKNNçš„è¯„ä¼°æŒ‡æ ‡
print_metrics(proto_eval_metrics)  # è¾“å‡ºProtoNetçš„è¯„ä¼°æŒ‡æ ‡
100
Kæ•°æ®

æ¨¡å‹
å‡†ç¡®ç‡ï¼ˆaccï¼‰
å¹³è¡¡å‡†ç¡®ç‡ï¼ˆbaccï¼‰
Cohen
's kappaç³»æ•°ï¼ˆkappaï¼‰
åŠ æƒF1å€¼ï¼ˆweighted_f1ï¼‰
knn20
0.969
0.957
0.981
0.969
proto
0.884
0.854
0.910
0.876
10
Kæ•°æ®

æ¨¡å‹
å‡†ç¡®ç‡ï¼ˆaccï¼‰
å¹³è¡¡å‡†ç¡®ç‡ï¼ˆbaccï¼‰
Cohen
's kappaç³»æ•°ï¼ˆkappaï¼‰
åŠ æƒF1å€¼ï¼ˆweighted_f1ï¼‰
knn20
0.969
0.956
0.984
0.969
proto
0.886
0.857
0.912
0.879
KNN(k=20)
ç›¸å…³æŒ‡æ ‡ï¼ˆ100
Kï¼‰

Test
knn20_accï¼ˆKNN(k=20)
çš„å‡†ç¡®ç‡ï¼‰ä¸º0
.969 ã€‚
Test
knn20_baccï¼ˆKNN(k=20)
çš„å¹³è¡¡å‡†ç¡®ç‡ï¼‰ä¸º0
.957 ã€‚
Test
knn20_kappaï¼ˆKNN(k=20)
çš„Cohen
's kappaç³»æ•°ï¼‰ä¸º0.981 ï¼Œè¡¨æ˜é¢„æµ‹ç»“æœä¸å®é™…ç»“æœä¸€è‡´æ€§å¾ˆé«˜ã€‚
Test
knn20_weighted_f1ï¼ˆKNN(k=20)
çš„åŠ æƒF1å€¼ï¼‰ä¸º0
.969 ã€‚æ•´ä½“æ¥çœ‹ï¼ŒKNN(k=20)
åœ¨æµ‹è¯•é›†ä¸Šè¡¨ç°è¾ƒä¸ºå‡ºè‰²ã€‚
Proto
ç›¸å…³æŒ‡æ ‡ï¼ˆ100
Kï¼‰

Test
proto_accï¼ˆProtoæ–¹æ³•çš„å‡†ç¡®ç‡ï¼‰ä¸º0
.884 ã€‚
Test
proto_baccï¼ˆProtoæ–¹æ³•çš„å¹³è¡¡å‡†ç¡®ç‡ï¼‰ä¸º0
.854 ã€‚
Test
proto_kappaï¼ˆProtoæ–¹æ³•çš„Cohen
's kappaç³»æ•°ï¼‰ä¸º0.910 ã€‚
Test
proto_weighted_f1ï¼ˆProtoæ–¹æ³•çš„åŠ æƒF1å€¼ï¼‰ä¸º0
.876 ã€‚ç›¸æ¯”KNN(k=20) ï¼ŒProtoæ–¹æ³•çš„å„é¡¹æŒ‡æ ‡ç•¥ä½ã€‚
ä¸ƒã€åŸºäºåŸå‹ç½‘ç»œï¼ˆProtoNetï¼‰çš„å°æ ·æœ¬å­¦ä¹ æ€§èƒ½è¯„ä¼°
è¿™æ®µä»£ç ç”¨äºè¯„ä¼°åŸºäºåŸå‹ç½‘ç»œï¼ˆProtoNetï¼‰çš„å°æ ·æœ¬å­¦ä¹ æ€§èƒ½ï¼Œé€šè¿‡å¤šæ¬¡æŠ½æ ·æ„å»ºä¸åŒçš„æ”¯æŒé›†ï¼Œå¹¶ç»Ÿè®¡æ¨¡å‹åœ¨æµ‹è¯•é›†ä¸Šçš„è¡¨ç°ã€‚

7 - 1ï¼šå¯¼å…¥è¯„ä¼°å‡½æ•°

from uni.downstream.eval_patch_features.fewshot import eval_fewshot

ä»æŒ‡å®šæ¨¡å—å¯¼å…¥eval_fewshotå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºæ‰§è¡Œå°æ ·æœ¬å­¦ä¹ çš„è¯„ä¼°æµç¨‹ã€‚

7 - 2ï¼šè°ƒç”¨è¯„ä¼°å‡½æ•°

fewshot_episodes, fewshot_dump = eval_fewshot(
    train_feats=train_feats,
    train_labels=train_labels,
    test_feats=test_feats,
    test_labels=test_labels,
    n_iter=100,  # ç”Ÿæˆ100ä¸ªå°æ ·æœ¬ä»»åŠ¡ï¼ˆepisodesï¼‰
    n_way=9,  # æ¯æ¬¡ä»»åŠ¡ä½¿ç”¨å…¨éƒ¨9ä¸ªç±»åˆ«
    n_shot=16,  # æ¯ä¸ªç±»å–16ä¸ªæ ·æœ¬ä½œä¸ºæ”¯æŒé›†ï¼ˆæ³¨é‡Šæåˆ°4ï¼Œå¯èƒ½å‚æ•°æˆ–æ³¨é‡Šä¸ä¸€è‡´ï¼‰
    n_query=test_feats.shape[0],  # æŸ¥è¯¢é›†ä¸ºå…¨éƒ¨æµ‹è¯•æ ·æœ¬
    center_feats=True,  # å¯¹ç‰¹å¾è¿›è¡Œä¸­å¿ƒåŒ–ï¼ˆå‡å»å‡å€¼ï¼‰
    normalize_feats=True,  # å¯¹ç‰¹å¾è¿›è¡ŒL2å½’ä¸€åŒ–
    average_feats=True,  # å¹³å‡æ”¯æŒé›†æ ·æœ¬ç‰¹å¾ä½œä¸ºç±»åŸå‹
)
è¾“å…¥æ•°æ®ï¼šä½¿ç”¨è®­ç»ƒå’Œæµ‹è¯•é›†çš„ç‰¹å¾åŠæ ‡ç­¾ã€‚
n_iter = 100ï¼šç”Ÿæˆ100ä¸ªç‹¬ç«‹çš„å°æ ·æœ¬ä»»åŠ¡ï¼Œä»¥è¯„ä¼°æ¨¡å‹é²æ£’æ€§ã€‚
n_way = 9ï¼šæ¯ä¸ªä»»åŠ¡åŒ…å«å…¨éƒ¨9ä¸ªç±»åˆ«ï¼ˆå‡è®¾æ•°æ®é›†å…±9ç±»ï¼‰ã€‚
n_shot = 16ï¼šæ¯ä¸ªç±»æŠ½å–16ä¸ªè®­ç»ƒæ ·æœ¬æ„å»ºæ”¯æŒé›†ï¼Œä½†æ³¨é‡Šæåˆ°4ï¼Œå¯èƒ½å­˜åœ¨ä¸ä¸€è‡´ã€‚
n_queryï¼šä½¿ç”¨æ‰€æœ‰æµ‹è¯•æ ·æœ¬ä½œä¸ºæŸ¥è¯¢é›†ï¼Œè¯„ä¼°æ•´ä½“æ€§èƒ½ã€‚
ç‰¹å¾å¤„ç†ï¼šä¸­å¿ƒåŒ–ã€å½’ä¸€åŒ–åè®¡ç®—ç±»åŸå‹ï¼ˆå‡å€¼ï¼‰ï¼Œä»¥æé«˜åˆ†ç±»æ•ˆæœã€‚
è¾“å‡ºç»“æœå±•ç¤º

display(fewshot_episodes)  # å±•ç¤ºæ¯ä¸ªepisodeçš„è¯¦ç»†è¯„ä¼°ç»“æœï¼ˆå¦‚å‡†ç¡®ç‡ï¼‰
display(fewshot_dump)  # æ˜¾ç¤ºæ±‡æ€»ç»Ÿè®¡ï¼ˆå¦‚å¹³å‡å‡†ç¡®ç‡ã€æ ‡å‡†å·®ï¼‰
fewshot_episodesï¼šåˆ—è¡¨å½¢å¼å­˜å‚¨æ¯ä¸ªå°æ ·æœ¬ä»»åŠ¡çš„ç»“æœï¼Œåæ˜ æ¨¡å‹åœ¨ä¸åŒæ”¯æŒé›†ä¸‹çš„è¡¨ç°æ³¢åŠ¨ã€‚
fewshot_dumpï¼šæ±‡æ€»ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚å¹³å‡å‡†ç¡®ç‡ï¼Œç”¨äºè¯„ä¼°æ•´ä½“æ€§èƒ½ã€‚
image - 20250317211847691
image - 20250317211847691
å…«ã€ProtoNetæ·±å…¥æ¢ç´¢
8 - 1ï¼šå¯¼å…¥ProtoNetç±»å¹¶åˆå§‹åŒ–æ¨¡å‹

from uni.downstream.eval_patch_features.protonet import ProtoNet

proto_clf = ProtoNet(metric='L2', center_feats=True, normalize_feats=True)
åŠŸèƒ½ï¼šä»è‡ªå®šä¹‰è·¯å¾„å¯¼å…¥ProtoNetç±»ï¼Œå¹¶åˆå§‹åŒ–æ¨¡å‹ã€‚
å‚æ•°è§£æï¼š
metric = 'L2'ï¼šä½¿ç”¨æ¬§æ°è·ç¦»ï¼ˆL2è·ç¦»ï¼‰ä½œä¸ºç›¸ä¼¼æ€§åº¦é‡ã€‚
center_feats = Trueï¼šåœ¨è®­ç»ƒæ—¶å¯¹ç‰¹å¾è¿›è¡Œä¸­å¿ƒåŒ–ï¼ˆå‡å»å‡å€¼ï¼‰ã€‚
normalize_feats = Trueï¼šå¯¹ç‰¹å¾è¿›è¡ŒL2å½’ä¸€åŒ–ã€‚
ä½œç”¨ï¼šé€šè¿‡ä¸­å¿ƒåŒ–å’Œå½’ä¸€åŒ–ï¼Œç¡®ä¿ç‰¹å¾åˆ†å¸ƒçš„ä¸€è‡´æ€§ï¼Œæå‡åŸå‹å­¦ä¹ çš„é²æ£’æ€§ã€‚
8 - 2ï¼šè®­ç»ƒæ¨¡å‹

proto_clf.fit(train_feats, train_labels)
print('What our prototypes look like', proto_clf.prototype_embeddings.shape)
åŠŸèƒ½ï¼šç”¨è®­ç»ƒæ•°æ®æ‹Ÿåˆæ¨¡å‹ï¼Œç”Ÿæˆæ¯ä¸ªç±»åˆ«çš„åŸå‹ï¼ˆprototypeï¼‰ã€‚
åŸå‹ç”Ÿæˆé€»è¾‘ï¼š
å¯¹æ¯ä¸ªç±»åˆ«ï¼Œè®¡ç®—å…¶æ‰€æœ‰æ ·æœ¬ç‰¹å¾çš„å‡å€¼ä½œä¸ºåŸå‹ã€‚ä¾‹å¦‚ï¼Œè‹¥ç±»åˆ«Aæœ‰100ä¸ªæ ·æœ¬ï¼Œåˆ™åŸå‹ä¸ºè¿™100ä¸ªç‰¹å¾çš„å‡å€¼å‘é‡ã€‚
è¾“å‡ºç¤ºä¾‹ï¼š(num_classes, feature_dim)ï¼Œè¡¨ç¤ºåŸå‹æ•°é‡ä¸ºç±»åˆ«æ•°ï¼Œæ¯ä¸ªåŸå‹çš„ç»´åº¦ä¸è¾“å…¥ç‰¹å¾ç›¸åŒã€‚
8 - 3ï¼šæ¨¡å‹é¢„æµ‹ä¸è¯„ä¼°

test_pred = proto_clf.predict(test_feats)
get_eval_metrics(test_labels, test_pred, get_report=False)
é¢„æµ‹é€»è¾‘ï¼šå¯¹äºæ¯ä¸ªæµ‹è¯•æ ·æœ¬ï¼Œè®¡ç®—å…¶ä¸æ‰€æœ‰åŸå‹çš„è·ç¦»ï¼Œé€‰æ‹©æœ€è¿‘çš„åŸå‹å¯¹åº”çš„ç±»åˆ«ä½œä¸ºé¢„æµ‹ç»“æœã€‚
æŒ‡æ ‡åç§°
10
K
100
K
å‡†ç¡®ç‡ï¼ˆaccï¼‰
0.8863509749303621
0.883844011
å¹³è¡¡å‡†ç¡®ç‡ï¼ˆbaccï¼‰
0.8569268574763045
0.853915962
Cohen
's kappaç³»æ•°ï¼ˆkappaï¼‰
0.9115189269748553
0.910136068
åŠ æƒF1å€¼ï¼ˆweighted_f1ï¼‰
0.8791473464186615
0.875913657
8 - 4ï¼šåŸºäºåŸå‹çš„æ£€ç´¢ï¼ˆROI
Retrievalï¼‰

1.
è·å–TopKæŸ¥è¯¢ç´¢å¼•
dist, topk_inds = proto_clf._get_topk_queries_inds(test_feats, topk=5)
ä½œç”¨ï¼šä»¥æµ‹è¯•ç‰¹å¾ä½œä¸ºæŸ¥è¯¢é›†ï¼Œè®¡ç®—æ¯ä¸ªåŸå‹æœ€è¿‘çš„topkä¸ªæµ‹è¯•æ ·æœ¬
è¾“å…¥ï¼š
test_featsï¼šæµ‹è¯•é›†çš„ç‰¹å¾çŸ©é˜µï¼ˆå½¢çŠ¶ï¼š[n_test_samples, feature_dim]ï¼‰
topk = 5ï¼šæ¯ä¸ªåŸå‹å–å‰5ä¸ªæœ€è¿‘æ ·æœ¬
è¾“å‡ºï¼š
distï¼šè·ç¦»çŸ©é˜µï¼ˆå½¢çŠ¶ï¼š[n_prototypes, n_test_samples]ï¼‰
topk_indsï¼šç´¢å¼•çŸ©é˜µï¼ˆå½¢çŠ¶ï¼š[n_prototypes, topk]ï¼‰ï¼Œæ¯è¡Œå¯¹åº”ä¸€ä¸ªåŸå‹çš„å‰5ä¸ªæœ€è¿‘æµ‹è¯•æ ·æœ¬çš„ç´¢å¼•
2.
æ‰“å°ç±»åˆ« - ç´¢å¼•æ˜ å°„å…³ç³»
print('label2idx correspondenes', test_dataset.class_to_idx)
ä½œç”¨ï¼šæ˜¾ç¤ºæ•°æ®é›†ä¸­ç±»åˆ«åç§°ä¸æ•°å­—ç´¢å¼•çš„å¯¹åº”å…³ç³»ï¼ˆä¾‹å¦‚ï¼š{'ADIPOSE': 0, 'LYMPHOCYTE': 3, ...}ï¼‰
æ„ä¹‰ï¼šè§£é‡Šåç»­ä»£ç ä¸­topk_inds[0]
ä¸ºä»€ä¹ˆå¯¹åº”ADIPOSEåŸå‹
è¾“å‡ºå¦‚ä¸‹ï¼š
label2idx
correspondenes
{'ADI': 0, 'BACK': 1, 'DEB': 2, 'LYM': 3, 'MUC': 4, 'MUS': 5, 'NORM': 6, 'STR': 7, 'TUM': 8}
3.
æ„å»ºæµ‹è¯•é›†å›¾ç‰‡è·¯å¾„DataFrame
test_imgs_df = pd.DataFrame(test_dataset.imgs, columns=['path', 'label'])
ç»“æ„

test_dataset.imgsï¼šPytorch
Datasetçš„æ ‡å‡†å±æ€§ï¼ŒåŒ…å«å…ƒç»„åˆ—è¡¨[(å›¾ç‰‡è·¯å¾„1, æ ‡ç­¾1), ...]
è½¬æ¢ä¸ºDataFrameåæœ‰ä¸¤åˆ—ï¼š
pathï¼šå›¾ç‰‡æ–‡ä»¶çš„ç»å¯¹ / ç›¸å¯¹è·¯å¾„
labelï¼šå¯¹åº”çš„æ•°å­—æ ‡ç­¾ï¼ˆéœ€é€šè¿‡class_to_idxæ˜ å°„ä¸ºç±»åˆ«åï¼‰
4.
ADIPOSEç±»åˆ«çš„Top5æ ·æœ¬å¯è§†åŒ–
print('Top-k ADIPOSE-like test samples to ADIPOSE prototype')
adi_topk_inds = topk_inds[0]  # å‡è®¾ADIPOSEåŸå‹çš„ç´¢å¼•æ˜¯0
adi_topk_imgs = concat_images([Image.open(img_fpath) for img_fpath in test_imgs_df['path'][adi_topk_inds]], scale=0.5,
                              gap=5)
display(adi_topk_imgs)
æµç¨‹

ä»topk_indsç¬¬0è¡Œè·å–ADIPOSEåŸå‹æœ€è¿‘çš„5ä¸ªæµ‹è¯•æ ·æœ¬ç´¢å¼•
é€šè¿‡test_imgs_df['path'][adi_topk_inds]
æå–è¿™äº›æ ·æœ¬çš„å›¾ç‰‡è·¯å¾„
ä½¿ç”¨PILåº“çš„Image.openåŠ è½½å›¾ç‰‡
concat_imagesï¼šè‡ªå®šä¹‰å‡½æ•°ï¼ˆæœªæ˜¾ç¤ºï¼‰ï¼Œå°†å¤šå¼ å›¾ç‰‡æ°´å¹³æ‹¼æ¥
scale = 0.5ï¼šå›¾ç‰‡ç¼©æ”¾50 %
gap = 5ï¼šå›¾ç‰‡é—´éš”5åƒç´ 
display()ï¼šåœ¨Jupyterä¸­æ¸²æŸ“æ‹¼æ¥åçš„å›¾ç‰‡
ADIPOSE
ADIPOSE
5.
å…¶ä»–ç±»åˆ«çš„å¯è§†åŒ–
LYMPHOCYTE

print('Top-k LYMPHOCYTE-like test samples to LYMPHOCYTE prototype')
lym_topk_inds = topk_inds[3]
lym_topk_imgs = concat_images([Image.open(img_fpath) for img_fpath in test_imgs_df['path'][lym_topk_inds]], scale=0.5,
                              gap=5)
display(lym_topk_imgs)
ç´¢å¼•è¯´æ˜ï¼šä¸åŒç±»åˆ«åœ¨topk_indsä¸­çš„è¡Œå·ç”±class_to_idxå†³å®š

ä¾‹å¦‚ï¼štest_dataset.class_to_idx['LYMPHOCYTE']
è¿”å›3ï¼Œå› æ­¤å–topk_inds[3]
LYMPHOCYTE
LYMPHOCYTE
TUMOR

print('Top-k TUMOR-like test samples to TUMOR prototype')
tum_topk_inds = topk_inds[8]
tum_topk_imgs = concat_images([Image.open(img_fpath) for img_fpath in test_imgs_df['path'][tum_topk_inds]], scale=0.5,
                              gap=5)
display(tum_topk_imgs)
image - 20250317214336418
image - 20250317214336418
å…¶ä½™ç±»å‹çš„å¯è§†åŒ–åˆ†æä»£ç åˆ—ä¸¾å¦‚ä¸‹ï¼Œæˆ‘ä¸å†å±•ç¤ºã€‚

print('Top-k MUCOSA-like test samples to MUCOSA prototype')
muc_topk_inds = topk_inds[4]
muc_topk_imgs = concat_images([Image.open(img_fpath) for img_fpath in test_imgs_df['path'][muc_topk_inds]], scale=0.5,
                              gap=5)
display(muc_topk_imgs)

print('Top-k MUSCLE-like test samples to MUSCLE prototype')
mus_topk_inds = topk_inds[5]
mus_topk_imgs = concat_images([Image.open(img_fpath) for img_fpath in test_imgs_df['path'][mus_topk_inds]], scale=0.5,
                              gap=5)
display(mus_topk_imgs)

print('Top-k NORMAL-like test samples to NORMAL prototype')
norm_topk_inds = topk_inds[6]
norm_topk_imgs = concat_images([Image.open(img_fpath) for img_fpath in test_imgs_df['path'][norm_topk_inds]], scale=0.5,
                               gap=5)
display(norm_topk_imgs)

print('Top-k STROMA-like test samples to STROMA prototype')
str_topk_inds = topk_inds[7]
str_topk_imgs = concat_images([Image.open(img_fpath) for img_fpath in test_imgs_df['path'][str_topk_inds]], scale=0.5,
                              gap=5)
display(str_topk_imgs)
ç§‘ç ”åˆä½œæ„å‘ç»Ÿè®¡

ä¸ºäº†æ›´å¥½çš„åˆ©ç”¨å°ç½—æ­å»ºçš„äº¤æµå¹³å°ï¼Œæˆ‘å†³å®šå‘æ”¾ä¸€ä¸ªé•¿æœŸæœ‰æ•ˆçš„é—®å·ï¼Œå¾é›†å¤§å®¶åœ¨ç§‘ç ”æ–¹é¢çš„ä»»ä½•éœ€æ±‚ï¼Œå¹¶ä¸”å®šæœŸæ•´ç†æ±‡æ€»ï¼Œæ–¹ä¾¿å¤§å®¶è¯¾é¢˜åˆä½œï¼Œæ‹›æ”¶å­¦ç”Ÿï¼Œè”ç³»å¯¼å¸ˆâ€¦â€¦

å›¾ç‰‡
ç»“æŸè¯­

æœ¬æœŸæ¨æ–‡çš„å†…å®¹å°±åˆ°è¿™é‡Œå•¦ï¼Œå¦‚æœéœ€è¦è·å–åŒ»å­¦AIé¢†åŸŸçš„æœ€æ–°å‘å±•åŠ¨æ€ï¼Œè¯·å…³æ³¨å°ç½—çš„æ¨é€ï¼å¦‚éœ€è¿›ä¸€æ­¥æ·±å…¥ç ”ç©¶ï¼Œè·å–ç›¸å…³èµ„æ–™ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒï¼
